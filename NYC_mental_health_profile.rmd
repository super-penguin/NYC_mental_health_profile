---
title: "New York City Mental Health Profile 2014"
author: "Penny"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages 
library(ggplot2)
library(reshape)
library(reshape2)
library(dplyr)
library(gridExtra)
library(taRifx)
library(gdata)
library(ggmap)
library(rgdal)
library(rgeos)
library(maptools)
library(tidyr)
library(tmap)
library(htmlwidgets)
library(taRifx)
library(leaflet)
```

### Introduction

Mental illness is one of the leading causes of disability in the world. In a report evaluating US Health from 1990-2010, the disease burden of mental illness is among the highest of all diseases [1]. Disease burden refers to the impact of a health problem measured by financial cost, mortality, morbidity, and other factors. Most patients with serious mental diseases or disorders spend years struggling without the ability to live a normal life. It is a big burden both for the patients, the family and our society.

New York City is facing the same problem with high rate of mental illness. Different studies have indicated possible relationship between urban life and higher risk of mental illness. In 2015, New York City launched an action plan called “thriveNYC”[2], aiming to change the way people think about mental health and provide more accessible services citywide. 

The goals of my project here are:    

1. To gain insights of the mental health situation in NYC;  

2. To discover potentially effective interventions and provide guidance for the distribution of fundings and services of NYC to finally improve new yorkers' mental health. 

The data I am using is from Health Data NY, Statewide Planning and Research Cooperative System (SPARCS)[3]. The raw data includes the NY hospitalization inpatient discharges for all diseases in 2014. 


References:    
[1] US Burden of Disease Collaborators. The state of US health, 1990-2010: burden of diseases, injuries, and risk factors. JAMA, 310(6): 591-608, 2013.     
[2] https://thrivenyc.cityofnewyork.us/      
[3] https://health.data.ny.gov/Health/Hospital-Inpatient-Discharges-SPARCS-De-Identified/mpue-vn67   

------------------------------------------

#### Dataset Exploration
* Load the dataset of patients information with all disease hospitalization in NY 2014

```{r echo=TRUE}
df14 <- read.csv("Hospital_Inpatient_Discharges__SPARCS_De-Identified___2014.csv")
```

* Subset data to find those with Mental Diseases & Disorders in NYC
    1. Subset data with patients from NYC
    2. Subset data with patients of mental diseases and disorders
    
    
    Based on the diagnosis of mental diseases and disorders, DRG code is used to extract mental diseases and disorders hospilization in the dataset. Neurological diseases and Drug & Alcohol abuses are excluded from the dataset. 
    
    Details of DRG code used are listed here: https://github.com/super-penguin/SPARCS-health-data.


```{r echo=TRUE}
# Subset the Data
# Subset the inpatient hospilization for Mental Diseases & Disorders of NYC in 2014
# The subset is based on DRG code
Mental.Code<- c(740, 750, 751, 752, 753, 754, 755, 756, 758, 759, 760, 561, 766)
County <- c("Bronx","Kings", "Manhattan", "Queens", "Richmond")
df14.NYC <- subset(df14, Hospital.County %in% County)
df14.mental<- subset(df14.NYC, APR.DRG.Code %in% Mental.Code)
```

------------------------------------------

###  1. Compare the top10 diseases in NYC 2014
#### 1.1. Plot top 10 diseases with highest hospitalization in NYC

* Remove the hospitalization data of Newborn, Naginal delivery and Cesarean delivery.
    + Those 3 are not caused by diseases.
    
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Convert the cost and charge ($) into integer for further exploration
df14.NYC$Total.Charges<- destring(df14.NYC$Total.Charges)
df14.NYC$Total.Costs<- destring(df14.NYC$Total.Costs)
df14.mental$Total.Charges<- destring(df14.mental$Total.Charges)
df14.mental$Total.Costs<- destring(df14.mental$Total.Costs)

# Group dataset by DRG code and sum patients number for each disease 
df14.NYC.DRG.Group<- df14.NYC %>%
    group_by(APR.DRG.Code, APR.DRG.Description) %>%
    summarise(Total.Patients.Number = n()) %>%
    arrange(Total.Patients.Number)
```

* Bar Plot of the Top 10 Diseases in NYC 2014


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=8, fig.height=8}

# Remove the hospilization data of Newborn, Naginal delivery and Cesarean delivery
# Those 4 are not caused by desease
new_df<- tail(df14.NYC.DRG.Group, 13)
new_df<- new_df[order(new_df$Total.Patients.Number, decreasing = TRUE), ]
new_df<- new_df[c(4:13),]

ggplot(new_df, aes(x = reorder(APR.DRG.Description, Total.Patients.Number), y =Total.Patients.Number)) +
    geom_bar(stat="identity") + 
    coord_flip() + 
    ggtitle("Top 10 diseases in NYC 2014") +
    labs (y = "Number of Patients") +
    theme(axis.title.y=element_blank())
```


In this figure, Schizophrenia and Bipolar Disorders are both belong to mental disorders. Among the top 10 diseases, two of them are mental disorders and Schizophrenia is the third most common one. It indicates the importance of understanding mental health situation in NYC.


#### 1.2. Plot the Number of Patients with Different Mental Diseases & Disorders by DRG Code

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=8, fig.height= 8}

df14.mental.new <- df14.mental %>%
    group_by(APR.DRG.Description) %>%
    summarise(Total.Patients.Number = n()) 
    

ggplot(df14.mental.new, aes(x = reorder(APR.DRG.Description, Total.Patients.Number), y = Total.Patients.Number)) +
    geom_bar(stat="identity") + 
    coord_flip() +
    ggtitle("Mental Diseases in NYC 2014") +
    labs (y = "Number of Patients") +
    theme(axis.title.y=element_blank())
```

Schizophrenia, Bipolar Disorders and Major Depressive Disorders are the TOP 3 most common mental illnesses in NYC 2014.

#### 1.3. Plot the Fraction of Patients Admitted Through Emergency Department for the Top 10 Diseases in NYC 2014


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=8, fig.height= 8}
df14.top10<- subset(df14, APR.DRG.Code %in% new_df$APR.DRG.Code)

df14.top10.Emergency <- df14.top10 %>%
    group_by(APR.DRG.Description, APR.DRG.Code, Emergency.Department.Indicator) %>%
    summarise(Total.Patients.Number = n()) %>%
    arrange(Total.Patients.Number)

df14.Emergency<- dcast(df14.top10.Emergency, APR.DRG.Code ~ Emergency.Department.Indicator, value.var="Total.Patients.Number")

df14.Emergency$EM_fraction <- (df14.Emergency$Y) / (df14.Emergency$N + df14.Emergency$Y)

new_df<- left_join(new_df, df14.Emergency, by = "APR.DRG.Code")

ggplot(new_df, aes(x = reorder(APR.DRG.Description, Total.Patients.Number), y = 100*EM_fraction)) +
    geom_bar(stat="identity") + 
    coord_flip() + 
    ggtitle("Percentage of Emergency Admission - Top 10 Diseases in NYC 2014") +
    labs (y = "Percentage of Emergency Admission (%)") +
    theme(axis.title.y=element_blank())
```

By comparing the emergent addmission rate of top 10 diseases in NYC, Schizophrenia and Bipolar Disorders are not the highest, but they all lie in the higher range (around 70%).**

Emergency admission rate of mental diseases & disorders implies the importance of early action on the road to improve mental health. Improving early counseling services and early responding team might be an effective way to provide patients with necessary help and prevent it from getting worse.


#### 1.4. Compare and Plot the Total Charges of the Top 10 Diseases in NYC 2014

```{r echo=FALSE}
df14.charges <- subset(df14.NYC, APR.DRG.Code %in% new_df$APR.DRG.Code)

ggplot(data = df14.charges, aes(x = APR.DRG.Description, y = as.numeric(Total.Charges))) +
    geom_boxplot(outlier.colour = NA) +
    coord_flip(ylim = c(0,100000)) +
    ggtitle("Total Charges of the Top 10 Diseases") +
    labs(y = "Total Charges($)") +
    theme(axis.title.y=element_blank())
```   

The averaged total charge of Schizophrenia is the third highest among the top 10 diseases. It is a huge financial burden both to the patients' family and our city.

####  1.5. Compare and Plot the Length of Hospitalization of the Top 10 Diseases in NYC 2014

```{r echo=FALSE}

ggplot(data = df14.charges, aes(x = APR.DRG.Description, y = as.numeric(Length.of.Stay))) +
    geom_boxplot() +
    coord_flip() +
    ggtitle("Length of Hospitalization of the Top 10 Diseases in NYC 2014") +
    labs(y = "Length of Hospitalization (day)") +
    theme(axis.title.y=element_blank())
```   

The hospitalization length of Schizophrenia and Biopolar Disorders are both in the higher range. Actually, this figure might not represent the actual long term burden of mental diseases. In fact, most patients still need extra care at home or specific facilities after discharging from the hospital. 

####  1.6. Observations and Reflections

In this chapter, the severity of mental disorders are compared with the top 10 diseases in NYC on different aspects. In 2014, schizophrenia alone was already the thrid leading cause of patient hospitalization in NYC. Besides the shocking number of patients with mental problems, the high charges and long hospitalization duration are heavy burden both to the patients and our city. Most patients with severe mental disorders lose the ability to work and live by themselves for years or even a lifetime. Extra care and cost is needed constantly.

From those figures, it is clear that mental health is one of the urgent problems to our city and effective data sharing should be coordinated to come up with new strategies.



###  2. Discover the vulnerable groups in NYC who are more likely to suffer from mental problems

####  2.1. Bar Plot of Patients with different age and racial groups  

* Group patients data by age and gender

```{r echo=TRUE, message=FALSE, warning=FALSE }
df14.fc_by_age_race <- df14.mental %>%
    filter(Race != "Multi-racial") %>%
    group_by(Age.Group, Race, Gender) %>%
    summarise(mean_days = mean(as.numeric(Length.of.Stay)),
              mean_costs = mean(as.numeric(Total.Costs)),
              n = n()) %>%
    arrange(Age.Group)
```

* Data Visualization - Bar Plot 

```{r echo=FALSE}
ggplot(data = df14.fc_by_age_race, aes(Age.Group, n, fill = Race)) + 
    geom_bar(position = "dodge", stat = "identity") + 
    ggtitle("NYC Mental Health 2014") +
    labs(x="Age Group", y="Patient Number")
```

There seems to have a significant racial difference in patients with mental diseases. In order to better quantify the racial differences, the patients number will be normalized to the corresponding racial population in the next figure.

####  2.2. Normalizing Patients Number with the Corresponding Racial Population

* The Estimated Population of NYC in 2014: 
    + Total Population: 8405837 
    + White: 33% - 2773926
    + Black/African American: 23% - 1933342
    + Other Race: 44% - 3698568

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Create a new Population Dataframe
Population<- data.frame(Race = as.character(c("White","Black/African American","Other Race")), 
                        race.population = c(2773926, 1933342, 3698568))
# Group data by race
df14.fc_by_race <- df14.fc_by_age_race %>%
    group_by(Race) %>%
    summarise(Total.Patients = sum(n))

df14.fc_by_race<- left_join(df14.fc_by_race, Population)
df14.fc_by_race$Percentage <- df14.fc_by_race$Total.Patients/df14.fc_by_race$race.population

ggplot(data = df14.fc_by_race, aes(Race, Percentage*100, fill=Race)) + 
    geom_bar(stat = "identity") + 
    ggtitle("NYC Mental Health - Racial Difference") +
    labs(y="Percentage to Corresponding Population (%)") 
```

#### Conclusion

**There is a significant racial difference for mental diseases and disorders hospitalization in NYC. The percentage of Black/African American with mental problems is almost two times compared with other races.**


#### 2.3. Bar Plot of Patients with different age and gender groups
```{r echo=FALSE}

ggplot(data = df14.fc_by_age_race, aes(Age.Group, n, fill = Gender)) + 
    geom_bar(position = "dodge", stat = "identity") + 
    ggtitle("NYC Mental Health 2014 - Gender Difference") +
    labs(x="Age Group", y="Number of Patients") 

```


###  3. Explore the temperal patterns of mental health hospitalization in NYC

####  3.1.  Compare the day of hospitalization admission for mental diseases and disorders in NYC

```{r echo=FALSE}

df14.mental$Admit.Day.of.Week <- factor(df14.mental$Admit.Day.of.Week, c("MON", "TUE", "WED", "THU", "FRI", "SAT", "SUN"))

df14.mental.day_of_week<- df14.mental %>%
    group_by(Admit.Day.of.Week, Emergency.Department.Indicator, APR.Severity.of.Illness.Code) %>%
    summarise(Mean.Charge = mean(as.numeric(Total.Charges)), 
              Mean.Cost = mean(as.numeric(Total.Costs)),
              Total.Patients.Number = n()) %>%
    arrange(Admit.Day.of.Week)

P_day_EM<- ggplot(aes(x = factor(Admit.Day.of.Week)), data = df14.mental[df14.mental$Emergency.Department.Indicator=="Y",]) + 
    geom_bar() + 
    ggtitle("NYC Mental Illness Emergency Admission 2014") +
    labs(x="Day of Week",y="number of patients") 

P_day_Total<- ggplot(aes(x = Admit.Day.of.Week), data = df14.mental) + 
    geom_bar() + 
    ggtitle("NYC Mental Illness Total Hospitalization Admission 2014") +
    labs(x="Day of Week",y="number of patients") 

grid.arrange(P_day_Total, P_day_EM, ncol = 1)

```

The plot of hospitalization admission date has an interesting pattern. The number of patients admitted are much higher during weekday compared with weekend. The trend goes up from Monday to Wednesday and down from Wednesday to Friday. Then it drops significantly on Saturday and keeps going lower on Sunday. This Interesting trend matches the working pressure during our daily life. It indicates that mental illness is highly likely to be triggered by work and study pressure in NYC.


### 4. Explore the relationship between total costs for mental diseases and the length of hospilization in NYC 2014
#### 4.1. Scatterplot of the relationship between total costs and length of hospilization in NYC 

```{r echo=FALSE, fig.width=16, fig.height= 16}

ggplot(data = df14.mental, aes(x = as.numeric(Length.of.Stay), y = as.numeric(Total.Costs))) +
    geom_point(alpha = 1/10, position = position_jitter(h=0), color = 'orange') +
    coord_cartesian(ylim=c(0,400000)) +
    geom_line(stat = 'summary', fun.y = mean) +
    geom_line(stat = 'summary', fun.y = quantile, fun.args = list(probs = .9), linetype =2, color = "red") +
    geom_line(stat = 'summary', fun.y = quantile, fun.args = list(probs = .1), linetype=2, color = "blue") +
    ggtitle("Length of Hospitalization vs. Costs for Different Mental Illness") +
    labs(x = "Length of Hospitalization", y = "Total Costs($)") +
    facet_wrap(~ APR.DRG.Description)
```

In this figure, the black line is the average cost, red line is the 90% quantile and blue line is the 10% quantile. The costs for hospilization increase in an interesting pattern along with the length of stay.There are spikes for cost on day 25 for several mental diseases. When the stay is longer than 25 days, the cost increases gradually along with stay. However, on certain number of days, the costs are always low. This interesting pattern needs further investigation.

Since the most common mental illness are schizophrenia, bipolar disorders and major depressive disorders, I am going to only investigate those 3 diseases and hopefully to find a pattern for the total cost and length of stay in the next figure. 

#### 4.2. Scatterplot of the relationship between total costs and length of stay for different payment methods with the top 3 mental illnesses

```{r echo=FALSE, fig.width=16, fig.height= 16}
TOP3<- c("SCHIZOPHRENIA", "BIPOLAR DISORDERS", "MAJOR DEPRESSIVE DISORDERS & OTHER/UNSPECIFIED PSYCHOSES")
ggplot(data = subset(df14.mental, APR.DRG.Description %in% TOP3), aes(x = as.numeric(Length.of.Stay), y = as.numeric(Total.Costs))) +
    geom_point(alpha = 1/10, position = position_jitter(h=0), color = 'orange') +
    coord_cartesian(ylim=c(0,400000)) +
    geom_line(stat = 'summary', fun.y = mean) +
    ggtitle("Length of Hospitalization vs. Costs - Different Payment Method") +
    labs(x = "Length of Hospitalization", y = "Total Costs($)") +
    facet_wrap(~ Payment.Typology.1)
```

The most common insurances used for mental illness are Medicaid and Medicare. There exits similar pattern in the plot of those two payment methods. I am sure there are information in other types of payment, however, I am going to investigate dataset containing only those two payment methods for the top 3 mental illnesses in the next figure.

#### 4.3. Further exploration of the relationship between total costs and length of stay
* Visualization if emergency admission has an effect on the relationship between total cost and length of stay
```{r echo=FALSE}
Payment<- c("Medicaid", "Medicare")
ggplot(data = subset(df14.mental, (APR.DRG.Description %in% TOP3) & (Payment.Typology.1 %in% Payment)), aes(x = as.numeric(Length.of.Stay), y = as.numeric(Total.Costs))) +
    geom_point(alpha = 1/5, position = position_jitter(h=0), aes(color = Emergency.Department.Indicator)) +
    coord_cartesian(ylim=c(0,400000)) +
    ggtitle("the Effect of Emergency Admission") +
    labs(x = "Length of Hospitalization", y = "Total Costs($)")
```

Interestingly, emergency admission does not seperate the plot at all. There is a big jump for the cost at day 25 and surprising low cost at some discrete days from 25-125. Except those discrete days with extraordinary low costs, the rest has a pretty good linear relationship between cost and length of stay. Finally, emergency admission does not affect this relationship in the figure. 

#### 4.4. Further exploration of the relation between total costs and length of stay
* Visualization if the severity of mental illness has an effect on the relationship between total cost and length of stay


```{r echo=FALSE, fig.width=16, fig.height= 16}
Payment<- c("Medicaid", "Medicare")
ggplot(data = subset(df14.mental, (APR.DRG.Description %in% TOP3) & (Payment.Typology.1 %in% Payment)), aes(x = as.numeric(Length.of.Stay), y = as.numeric(Total.Costs))) +
    geom_point(alpha = 1/3, position = position_jitter(h=0), aes(color = Emergency.Department.Indicator)) +
    coord_cartesian(ylim=c(0,400000)) +
    ggtitle("the Effect of Emergency Admission & Severity of Illness") +
    labs(x = "Length of Hospitalization", y = "Total Costs($)") +
    facet_wrap(~APR.Severity.of.Illness.Code)
```

The severity of illness is defined by number from 1-4. 1 is the least serious and 4 is the most serious type. The percentages of emergency admission are higher for more severe mental illnesses (with number 3 and 4). The big jump of high cost exits in severity from 1-3, expecially for severity 2 which has the highest patient numbers.

Surprisingly, the severity of mental illness does not have a seperation for the interesting pattern either. In conclusion, all the factors (including different mental illness, different method of payment, emergency admission and different severity of illness) do not affect the pattern of total costs along with the length of hospitalization. 

Based on those results, I suspect that this interesting pattern might be caused by different hospital types. However, I do not have enough information, further study and analysis need to be performed to answer this question. 


### Final Plots
#### Final plot 1 - The Racial Difference in Mental Illness of NYC 2014

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data = df14.fc_by_race, aes(Race, Percentage*100, fill=Race)) + 
    geom_bar(stat = "identity") + 
    ggtitle("NYC Mental Health - Racial Difference") +
    labs(y="Percentage to Corresponding Population (%)") 
```

#### Final plot 2 - The Gender and Age Difference in Mental Illness of NYC 2014

```{r echo=FALSE}

ggplot(data = df14.fc_by_age_race, aes(Age.Group, n, fill = Gender)) + 
    geom_bar(position = "dodge", stat = "identity") + 
    ggtitle("NYC Mental Health 2014 - Gender & Age Difference") +
    labs(x="Age Group", y="Number of Patients") 
```

#### Final plot 3 - the Day of Hospitalization Admission for Mental Illness in NYC 2014

```{r echo=FALSE}
ggplot(aes(x = factor(Admit.Day.of.Week)), data = df14.mental[df14.mental$Emergency.Department.Indicator=="Y",]) + 
    geom_bar() + 
    ggtitle("NYC Mental Illness Emergency Admission 2014") +
    labs(x="Day of Week", y="number of patients") 
```

#### Observations and Reflections for Final Plot 1-3

There is a significant racial and gender difference for mental diseases and disorders hospitalization in NYC. 

In 2014, Black/African Americans have the highest mental disorder hospitalizations in almost every age group compared with other racial groups. I researched for potential reasons. One possible explanation is genetic difference. However, I didn’t find much evidence to support this assumption. Another possible reason is the bias in mental disorder diagnosis, which means one race is more likely to be diagnosed with severe mental disorders. There are some studies showing that a Black/African American is more likely to be diagnosed as schizophrenia with the same symptom when a White American is diagnosed as depression. However, this observation does not explain my results since I grouped all those possible mental diseases together. I will explore the data further to see if I could come up with a reasonable explanation for racial difference.

The second figure indicates that people aged from 30-49 are more likely to suffer from mental problems. From thriveNYC, a lot of money and efforts are aiming to help or prevent mental problems in younger people. However, my results gave a different perspective. Middle aged people are the most vulnerable group. It might be caused by higher pressure both from family and society. In conclusion, I believe more attention should be paid to improve the mental health of middle aged group. Mental health counseling or service should be provided more widely in workplace and community. 

The gender difference is another interesting observation. I was debating if I should include Maternal Depression into the total mental health data, since it might cause gender bias in the final results. However, even if I included Maternal Depression, male adults still have much higher hospilization rate with mental problems. It also indicates that work and family pressure might be one of the leading cause to induce mental problems in NYC. 

Finally, the number of patients admitted are much higher during weekday compared with weekend. The trend goes up from Monday to Wednesday and down from Wednesday to Friday. Then it drops significantly on Saturday and keeps going lower on Sunday. This Interesting trend matches the working pressure during our daily life. It indicates that mental illness is highly likely to be triggered by work and study pressure in NYC.

#### Final plot 4 - Map NYC mental diseases and disorders hospitalization into County Level

* Prepare the map shapefile.
    + New York City shape files could be downloaded from:       http://www1.nyc.gov/site/planning/data-maps/open-data/districts-download-metadata.page

* Load NYC map at county level.

* Population at county level:
    + Bronx: 1418733
    + Brooklyn (Kings): 2592149
    + Manhattan: 1626159
    + Queens: 2296175
    + Staten Island (Richmond): 472621

```{r echo=FALSE, message=FALSE, warning=FALSE}
NYC.map <- readOGR(dsn = "nybb_16c", layer = "nybb")

# Drop factor levels
df14.mental$Hospital.County<- factor(df14.mental$Hospital.County)

df14.mental.county <- df14.mental %>%
    filter(!is.na(Hospital.County)) %>%
    mutate(Total.Costs = as.numeric(destring(Total.Costs))) %>%
    group_by(Hospital.County) %>%
    summarise(mean_costs = mean(Total.Costs),
              Total.Patients = n()) %>%
    arrange(Hospital.County)

Population.Profile<- data.frame(County = c("Bronx", "Kings", "Manhattan", "Queens", "Richmond"), 
                                Population = c(1418733, 2592149, 1626159, 2296175, 472621))

df14.mental.county<- merge(df14.mental.county, Population.Profile, by.x = "Hospital.County", by.y = "County")
df14.mental.county$Hospital.County<- c("Bronx", "Brooklyn", "Manhattan", "Queens", "Staten Island")

colnames(df14.mental.county)[1]<- "BoroName"

NYC.map@data<- left_join(NYC.map@data, df14.mental.county)
NYC.map@data$Patient.to.Population <- (NYC.map@data$Total.Patients / NYC.map@data$Population)*10000
```


```{r echo=FALSE, message=FALSE, warning=FALSE}

NYC.map1 <- spTransform(NYC.map, CRS("+proj=longlat +datum=WGS84"))

mypopup <- paste(sep = "<br/>", NYC.map1@data$BoroName, 
                  "Total Patients Number: ", NYC.map1@data$Total.Patients,
                  "Populations: ", NYC.map1@data$Population,
                  "Patients per 10,000 populations: ", round(NYC.map1@data$Patient.to.Population, digits = 0),
                 "Average Cost for Mental Hospilization: ", round(NYC.map1@data$mean_costs, digits =2))

myPalette1 <- colorNumeric(palette = "Reds", domain=NYC.map1@data$Total.Patients)
myPalette2<- colorNumeric(palette = "Reds", domain=NYC.map1@data$Population)
myPalette3<- colorNumeric(palette = "Reds", domain=NYC.map1@data$Patient.to.Population)
myPalette4<- colorNumeric(palette = "Blues", domain=NYC.map1@data$mean_costs)
```

#### Map Patients Number (per 1,000 Population) with Mental Problems

```{r echo=FALSE, message=FALSE, warning=FALSE}

NYC.map.layer<- leaflet(NYC.map1) %>%
    addProviderTiles("CartoDB.DarkMatter") %>%
    addPolygons(stroke = TRUE, weight = 1, smoothFactor = 0.2, fillOpacity = 0.8, 
                popup =mypopup, color = ~ myPalette3(NYC.map1@data$Patient.to.Population),
                group ="Patients per 10,000 population") %>%
    addPolygons(stroke = TRUE, weight = 1, smoothFactor = 0.2, fillOpacity = 0.8, 
                popup =mypopup, color = ~ myPalette1(NYC.map1@data$Total.Patients),
                group = "Patients number") %>%
    addPolygons(stroke = TRUE, weight = 1, smoothFactor = 0.2, fillOpacity = 0.8, 
                popup =mypopup, color = ~ myPalette2(NYC.map1@data$Population),
                group ="Population") %>%
    addLayersControl( 
        baseGroups=c("Patients per 1k Population", "Patients number", "Population"),
        position = "topleft",
        options = layersControlOptions(collapsed = FALSE)) %>%
    
    addLegend(position = "bottomleft", pal = myPalette3, 
              values = NYC.map1@data$Patient.to.Population, title = "Patients per 1k Population") %>%
    
    fitBounds(-74.3, 40.5, -73.7, 40.9) 

NYC.map.layer
```

"leaflet" package is used in this figure to build an interactive map. This map has 3 layers. The first layer with popup "Total Patients Number" displays patients number at each county on the map; The second layer with popup "Populations" displays total population at each county on the map; Finally, the last layer with popup "Patients per 10,000 populations" shows the patients number per 10,000 population at each county.

#### Observations and Reflections for Final Plot 4 - Map 1

In the five counties of new york city, Manhattan does not have the largest population, however it has the largest patients number with mental problems compared with other counties. When normalized with the county population, the difference gets more bigger. Manhattan has much more patients with mental diseases and disorders per 10,000 population compared with other counties in NYC. 

This result is not surprising. The condensed population and high living pressure in manhattan might be the leading cause for this difference. Based on this observation, more fundings and services should be distributed in manhattan to improve mental health of new yorkers.


#### Map Avearge Costs of Mental Diseases and Disorders Hospitalization

```{r echo=FALSE}
NYC.map.cost<- leaflet(NYC.map1) %>%
    addProviderTiles("CartoDB.DarkMatter") %>%
    addPolygons(stroke = TRUE, weight = 1, smoothFactor = 0.2, fillOpacity = 0.8, 
                popup =mypopup, color = ~ myPalette4(NYC.map1@data$mean_costs)) %>%
    addLegend(position = "topleft", pal = myPalette4, 
              values = NYC.map1@data$mean_costs, title = "Average Costs (2014)",
              labFormat = labelFormat(prefix = "$"), opacity = 1 ) %>%
    fitBounds(-74.3, 40.5, -73.7, 40.9)
    
NYC.map.cost
```

#### Observations and Reflections for Final Plot 4 - Map 2

On this map, Bronx has the highest averaged cost for the hospitalization of mental diseases and disorders. This is quite surprising. Manhattan has the highest mental patients percentage but the costs for mental diseases and disorders hospitalization is less than Bronx. If you take a closer look at the legend, the average cost for hospitalization of mental diseases in Bronx is twice as much as on Staten Island.

Further information is needed to investigate the reason for this and I believe the city goverment and other facilities need to look into this problem. If necessary, action should be taken to decrease the cost for hospitalization in Bronx.


#### Final Reflections

This dataset is limited in many ways. First, patients hospilization infomation in this dataset does not account for the readmission. Patients with mental diseases and disorders have a high readmission rate, but when I am analyzing this dataset, the readmission rate is missing. Bias might be induced by this missing factor and interesting observation might be ignored without the consideration of readmission.  

In addition, due to the confidential problem, the zip code information for patients is not complete. It only has the first 3 digits, which makes it impossible to map the mental health profile into community level. New york city is a large and ethnically diverse metropolis. Analysis on county level does not provide enough information refecting the health situation when considering the diverse demographic characteristics of each community. I will continue this project with more detailed data and hopefully to map a better NYC mental health profile.


